---
layout: page
title: Docker Manual
permalink: /manuals/docker
---

#### Подключение приложения в docker контейнере к сервисам на host системе.

ОС - Linux.

В качестве сервиса host системы возьмем PostgreSQL.

##### Немного теории:

По умолчанию Docker использует `bridge network driver` для сетевой конфигурации.
 
`bridge ` - это устройство канального уровня, которое соеденяет несколько сетевых сегментов.
Устройство может быть "железным" или "програмнным".

Docker использует программную реализацию `bridge`. 
Этот подход работает в приделах одного хоста. Мост используется для коммуникации контейнеров между собой
В конфигурацию iptables автоматически добавляются необходимые правила.

Можно использовать стандартный bridge или создать новую docker сеть. 
Во втором случае необходимо учитывать что контейнеры из разных сетей не смогут коммуницировать 
между собой без дополнительных настроек.

Со стороны host системы docker bridge - standard Linux network bridg.
[Подронее - Arch Wiki Network Bridge](https://wiki.archlinux.org/index.php/Network_bridge)

##### Адаптируем PostgreSQL для подключения со стороны docker сети.

Используя теорию выше мы можем адаптировать наши хостовые сервисы для доступа из docker сети.

Для этого:
 0. С помощью `ifconfig` определяем ip адресс стандартного docker bridge. 
    По умолчанию интерфейс называется `docker0`. Для примера возьмем адрес `172.17.0.1` 
 1. Настраиваем PostreSQL на прослушивание адреса `172.17.0.1`
 2. В pg_hba.conf разрешаем подключение с паролем из сети `172.17.0.0/24`
 3. Если у нас настроен iptables добавляем в него правило для доступа к PostgreSQL из сети docker.
    
    Пример правила: `iptables -A INPUT -s 172.17.0.0/24 -i docker -p tcp -m tcp --dport 5432  -j ACCEPT`

 ##### Адаптируем приложения в контейнере.

В настройках приложения в качестве хоста базы данных необходимо указать `172.17.0.1`.

Дополнительных настроек не требуется.

В версия докер 18.04+ адрес установленный на bridge интерефейсе автоматически будет доступен по dns имени 
`host.docker.internal`. 

Хотя судя по открытому [pull request](https://github.com/docker/for-linux/issues/264) пока не работоспособен в Linux.

